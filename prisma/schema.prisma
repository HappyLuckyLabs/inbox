generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String              @id @default(cuid())
  email        String              @unique
  name         String?
  password     String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  platforms    ConnectedPlatform[]
  contacts     Contact[]
  topics       ConversationTopic[]
  summaries    DailySummary[]
  messages     Message[]
  todos        TodoItem[]
  goals        UserGoal[]
  interactions UserInteraction[]
  preferences  UserPreference?
}

model ConnectedPlatform {
  id               String    @id @default(cuid())
  userId           String
  platform         String
  accountId        String?
  accountName      String?
  platformUserId   String?
  platformUsername String?
  accessToken      String?
  refreshToken     String?
  expiresAt        DateTime?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, platform])
}

model Contact {
  id               String             @id @default(cuid())
  userId           String
  name             String
  email            String?
  avatar           String?
  platformId       String
  platform         String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  importance       ContactImportance?
  sentMessages     Message[]          @relation("SentMessages")
  receivedMessages Message[]          @relation("ReceivedMessages")

  @@unique([userId, platformId, platform])
}

model Message {
  id                String            @id @default(cuid())
  userId            String
  conversationId    String?
  platform          String
  platformMessageId String?
  externalId        String?
  threadId          String?
  fromContactId     String?
  toContactId       String?
  from              String?
  fromName          String?
  to                String?
  subject           String?
  body              String
  snippet           String?
  isRead            Boolean           @default(false)
  priority          Int               @default(0)
  sentiment         String?
  category          String?
  attachments       String?
  metadata          String?
  receivedAt        DateTime          @default(now())
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  fromContact       Contact?          @relation("SentMessages", fields: [fromContactId], references: [id])
  toContact         Contact?          @relation("ReceivedMessages", fields: [toContactId], references: [id])
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  embedding         MessageEmbedding?

  @@index([userId, platform])
  @@index([userId, priority])
  @@index([userId, receivedAt])
}

model UserPreference {
  id                    String    @id @default(cuid())
  userId                String    @unique
  writingStyle          String?
  priorities            String?
  autoReply             Boolean   @default(false)
  preferredResponseTime String?
  communicationStyle    String?
  keywordImportance     String?
  senderPreferences     String?
  platformPreferences   String?
  samplesAnalyzed       Int       @default(0)
  lastLearningRun       DateTime?
  learningVersion       Int       @default(1)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserGoal {
  id            String   @id @default(cuid())
  userId        String
  goal          String
  category      String
  priority      Int      @default(5)
  status        String   @default("active")
  confidence    Float    @default(0.5)
  extractedFrom String?
  keywords      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, priority])
}

model ConversationTopic {
  id             String   @id @default(cuid())
  userId         String
  name           String
  description    String?
  category       String
  importance     Int      @default(5)
  messageIds     String?
  participantIds String?
  platforms      String?
  lastActivityAt DateTime
  firstSeenAt    DateTime @default(now())
  messageCount   Int      @default(0)
  embedding      String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, lastActivityAt])
  @@index([userId, importance])
}

model ContactImportance {
  id               String    @id @default(cuid())
  userId           String
  contactId        String    @unique
  importanceScore  Float     @default(5.0)
  responseRate     Float     @default(0.0)
  avgResponseTime  Int?
  interactionCount Int       @default(0)
  lastInteraction  DateTime?
  tags             String?
  contact          Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([userId, contactId])
  @@index([userId, importanceScore])
}

model TodoItem {
  id             String    @id @default(cuid())
  userId         String
  title          String
  description    String?
  dueDate        DateTime?
  priority       Int       @default(5)
  status         String    @default("pending")
  extractedFrom  String?
  messageSnippet String?
  confidence     Float     @default(0.5)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status, dueDate])
  @@index([userId, status])
}

model UserInteraction {
  id        String   @id @default(cuid())
  userId    String
  eventType String
  messageId String?
  contactId String?
  metadata  String?
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, eventType, timestamp])
  @@index([userId, timestamp])
}

model DailySummary {
  id            String   @id @default(cuid())
  userId        String
  date          DateTime
  summary       String
  topMessages   String?
  topTopics     String?
  actionItems   String?
  messageCount  Int
  unreadCount   Int
  priorityCount Int
  generatedAt   DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model MessageEmbedding {
  id        String  @id @default(cuid())
  messageId String  @unique
  embedding String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}
